
const animatedBlintzFold = {
	"file_spec": 1.1,
	"file_author": "Robby Kraft",
	"file_classes": ["singleModel"],
	"frame_attributes": ["3D"],
	"frame_title": "blintz base",
	"frame_classes": ["creasePattern"],
	"vertices_coords": [
		[0.0, 0.0, 0.0], [0.5, 0.0, 0.0],
		[1.0, 0.0, 0.0], [1.0, 0.5, 0.0],
		[1.0, 1.0, 0.0], [0.5, 1.0, 0.0],
		[0.0, 1.0, 0.0], [0.0, 0.5, 0.0]
	],
	"edges_vertices": [[0,1], [1,2], [2,3], [3,4], [4,5], [5,6], [6,7], [7,0], [1,3], [3,5], [5,7], [7,1]],
	"edges_assignment": ["B","B","B","B","B","B","B","B","V","V","V","V"],
	"faces_vertices": [[0,1,7], [2,3,1], [4,5,3], [6,7,5], [1,3,5,7]],
	"faces_layer": [4,0,1,2,3],
	"file_frames": [
		{
			"frame_classes": ["foldedState"],
			"frame_parent": 0,
			"frame_inherit": true,
			"vertices_coords": [
				[0.0012038183319507678, 0.0012038183319507678, 0.02450428508239015], [0.5, 0.0, 0.0],
				[0.9987961816680493, 0.0012038183319507678, 0.02450428508239015], [1.0, 0.5, 0.0],
				[0.9987961816680493, 0.9987961816680493, 0.02450428508239015], [0.5, 1.0, 0.0],
				[0.0012038183319507678, 0.9987961816680493, 0.02450428508239015], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.004803679899192392, 0.004803679899192392, 0.04877258050403206], [0.5, 0.0, 0.0],
				[0.9951963201008076, 0.004803679899192392, 0.04877258050403206], [1.0, 0.5, 0.0],
				[0.9951963201008076, 0.9951963201008076, 0.04877258050403206], [0.5, 1.0, 0.0],
				[0.004803679899192392, 0.9951963201008076, 0.04877258050403206], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.010764916066947794, 0.010764916066947794, 0.07257116931361558], [0.5, 0.0, 0.0],
				[0.9892350839330522, 0.010764916066947794, 0.07257116931361558], [1.0, 0.5, 0.0],
				[0.9892350839330522, 0.9892350839330522, 0.07257116931361558], [0.5, 1.0, 0.0],
				[0.010764916066947794, 0.9892350839330522, 0.07257116931361558], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.019030116872178315, 0.019030116872178315, 0.09567085809127245], [0.5, 0.0, 0.0],
				[0.9809698831278217, 0.019030116872178315, 0.09567085809127245], [1.0, 0.5, 0.0],
				[0.9809698831278217, 0.9809698831278217, 0.09567085809127245], [0.5, 1.0, 0.0],
				[0.019030116872178315, 0.9809698831278217, 0.09567085809127245], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.029519683912911238, 0.029519683912911238, 0.11784918420649941], [0.5, 0.0, 0.0],
				[0.9704803160870887, 0.029519683912911238, 0.11784918420649941], [1.0, 0.5, 0.0],
				[0.9704803160870887, 0.9704803160870887, 0.11784918420649941], [0.5, 1.0, 0.0],
				[0.029519683912911238, 0.9704803160870887, 0.11784918420649941], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.04213259692436369, 0.04213259692436369, 0.13889255825490054], [0.5, 0.0, 0.0],
				[0.9578674030756363, 0.04213259692436369, 0.13889255825490054], [1.0, 0.5, 0.0],
				[0.9578674030756363, 0.9578674030756363, 0.13889255825490054], [0.5, 1.0, 0.0],
				[0.04213259692436369, 0.9578674030756363, 0.13889255825490054], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.05674738665931575, 0.05674738665931575, 0.15859832104091137], [0.5, 0.0, 0.0],
				[0.9432526133406842, 0.05674738665931575, 0.15859832104091137], [1.0, 0.5, 0.0],
				[0.9432526133406842, 0.9432526133406842, 0.15859832104091137], [0.5, 1.0, 0.0],
				[0.05674738665931575, 0.9432526133406842, 0.15859832104091137], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.0732233047033631, 0.0732233047033631, 0.17677669529663687], [0.5, 0.0, 0.0],
				[0.9267766952966369, 0.0732233047033631, 0.17677669529663687], [1.0, 0.5, 0.0],
				[0.9267766952966369, 0.9267766952966369, 0.17677669529663687], [0.5, 1.0, 0.0],
				[0.0732233047033631, 0.9267766952966369, 0.17677669529663687], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.09140167895908863, 0.09140167895908863, 0.19325261334068422], [0.5, 0.0, 0.0],
				[0.9085983210409114, 0.09140167895908863, 0.19325261334068422], [1.0, 0.5, 0.0],
				[0.9085983210409114, 0.9085983210409114, 0.19325261334068422], [0.5, 1.0, 0.0],
				[0.09140167895908863, 0.9085983210409114, 0.19325261334068422], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.11110744174509943, 0.11110744174509943, 0.2078674030756363], [0.5, 0.0, 0.0],
				[0.8888925582549005, 0.11110744174509943, 0.2078674030756363], [1.0, 0.5, 0.0],
				[0.8888925582549005, 0.8888925582549005, 0.2078674030756363], [0.5, 1.0, 0.0],
				[0.11110744174509943, 0.8888925582549005, 0.2078674030756363], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.13215081579350055, 0.13215081579350055, 0.22048031608708873], [0.5, 0.0, 0.0],
				[0.8678491842064995, 0.13215081579350055, 0.22048031608708873], [1.0, 0.5, 0.0],
				[0.8678491842064995, 0.8678491842064995, 0.22048031608708873], [0.5, 1.0, 0.0],
				[0.13215081579350055, 0.8678491842064995, 0.22048031608708873], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.15432914190872754, 0.15432914190872754, 0.23096988312782168], [0.5, 0.0, 0.0],
				[0.8456708580912724, 0.15432914190872754, 0.23096988312782168], [1.0, 0.5, 0.0],
				[0.8456708580912724, 0.8456708580912724, 0.23096988312782168], [0.5, 1.0, 0.0],
				[0.15432914190872754, 0.8456708580912724, 0.23096988312782168], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.17742883068638443, 0.17742883068638443, 0.23923508393305223], [0.5, 0.0, 0.0],
				[0.8225711693136155, 0.17742883068638443, 0.23923508393305223], [1.0, 0.5, 0.0],
				[0.8225711693136155, 0.8225711693136155, 0.23923508393305223], [0.5, 1.0, 0.0],
				[0.17742883068638443, 0.8225711693136155, 0.23923508393305223], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.20122741949596792, 0.20122741949596792, 0.2451963201008076], [0.5, 0.0, 0.0],
				[0.7987725805040321, 0.20122741949596792, 0.2451963201008076], [1.0, 0.5, 0.0],
				[0.7987725805040321, 0.7987725805040321, 0.2451963201008076], [0.5, 1.0, 0.0],
				[0.20122741949596792, 0.7987725805040321, 0.2451963201008076], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.2254957149176098, 0.2254957149176098, 0.2487961816680492], [0.5, 0.0, 0.0],
				[0.7745042850823902, 0.2254957149176098, 0.2487961816680492], [1.0, 0.5, 0.0],
				[0.7745042850823902, 0.7745042850823902, 0.2487961816680492], [0.5, 1.0, 0.0],
				[0.2254957149176098, 0.7745042850823902, 0.2487961816680492], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.25, 0.25, 0.25], [0.5, 0.0, 0.0],
				[0.75, 0.25, 0.25], [1.0, 0.5, 0.0],
				[0.75, 0.75, 0.25], [0.5, 1.0, 0.0],
				[0.25, 0.75, 0.25], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.27450428508239016, 0.27450428508239016, 0.24879618166804923], [0.5, 0.0, 0.0],
				[0.7254957149176098, 0.27450428508239016, 0.24879618166804923], [1.0, 0.5, 0.0],
				[0.7254957149176098, 0.7254957149176098, 0.24879618166804923], [0.5, 1.0, 0.0],
				[0.27450428508239016, 0.7254957149176098, 0.24879618166804923], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.29877258050403205, 0.29877258050403205, 0.2451963201008076], [0.5, 0.0, 0.0],
				[0.701227419495968, 0.29877258050403205, 0.2451963201008076], [1.0, 0.5, 0.0],
				[0.701227419495968, 0.701227419495968, 0.2451963201008076], [0.5, 1.0, 0.0],
				[0.29877258050403205, 0.701227419495968, 0.2451963201008076], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.3225711693136155, 0.3225711693136155, 0.23923508393305223], [0.5, 0.0, 0.0],
				[0.6774288306863845, 0.3225711693136155, 0.23923508393305223], [1.0, 0.5, 0.0],
				[0.6774288306863845, 0.6774288306863845, 0.23923508393305223], [0.5, 1.0, 0.0],
				[0.3225711693136155, 0.6774288306863845, 0.23923508393305223], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.3456708580912724, 0.3456708580912724, 0.23096988312782168], [0.5, 0.0, 0.0],
				[0.6543291419087276, 0.3456708580912724, 0.23096988312782168], [1.0, 0.5, 0.0],
				[0.6543291419087276, 0.6543291419087276, 0.23096988312782168], [0.5, 1.0, 0.0],
				[0.3456708580912724, 0.6543291419087276, 0.23096988312782168], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.3678491842064994, 0.3678491842064994, 0.22048031608708876], [0.5, 0.0, 0.0],
				[0.6321508157935005, 0.3678491842064994, 0.22048031608708876], [1.0, 0.5, 0.0],
				[0.6321508157935005, 0.6321508157935005, 0.22048031608708876], [0.5, 1.0, 0.0],
				[0.3678491842064994, 0.6321508157935005, 0.22048031608708876], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.3888925582549005, 0.3888925582549005, 0.20786740307563634], [0.5, 0.0, 0.0],
				[0.6111074417450995, 0.3888925582549005, 0.20786740307563634], [1.0, 0.5, 0.0],
				[0.6111074417450995, 0.6111074417450995, 0.20786740307563634], [0.5, 1.0, 0.0],
				[0.3888925582549005, 0.6111074417450995, 0.20786740307563634], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.4085983210409113, 0.4085983210409113, 0.19325261334068428], [0.5, 0.0, 0.0],
				[0.5914016789590887, 0.4085983210409113, 0.19325261334068428], [1.0, 0.5, 0.0],
				[0.5914016789590887, 0.5914016789590887, 0.19325261334068428], [0.5, 1.0, 0.0],
				[0.4085983210409113, 0.5914016789590887, 0.19325261334068428], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.42677669529663687, 0.42677669529663687, 0.1767766952966369], [0.5, 0.0, 0.0],
				[0.5732233047033631, 0.42677669529663687, 0.1767766952966369], [1.0, 0.5, 0.0],
				[0.5732233047033631, 0.5732233047033631, 0.1767766952966369], [0.5, 1.0, 0.0],
				[0.42677669529663687, 0.5732233047033631, 0.1767766952966369], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.4432526133406842, 0.4432526133406842, 0.15859832104091137], [0.5, 0.0, 0.0],
				[0.5567473866593158, 0.4432526133406842, 0.15859832104091137], [1.0, 0.5, 0.0],
				[0.5567473866593158, 0.5567473866593158, 0.15859832104091137], [0.5, 1.0, 0.0],
				[0.4432526133406842, 0.5567473866593158, 0.15859832104091137], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.45786740307563634, 0.45786740307563634, 0.13889255825490054], [0.5, 0.0, 0.0],
				[0.5421325969243637, 0.45786740307563634, 0.13889255825490054], [1.0, 0.5, 0.0],
				[0.5421325969243637, 0.5421325969243637, 0.13889255825490054], [0.5, 1.0, 0.0],
				[0.45786740307563634, 0.5421325969243637, 0.13889255825490054], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.47048031608708873, 0.47048031608708873, 0.11784918420649947], [0.5, 0.0, 0.0],
				[0.5295196839129113, 0.47048031608708873, 0.11784918420649947], [1.0, 0.5, 0.0],
				[0.5295196839129113, 0.5295196839129113, 0.11784918420649947], [0.5, 1.0, 0.0],
				[0.47048031608708873, 0.5295196839129113, 0.11784918420649947], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.4809698831278217, 0.4809698831278217, 0.09567085809127247], [0.5, 0.0, 0.0],
				[0.5190301168721783, 0.4809698831278217, 0.09567085809127247], [1.0, 0.5, 0.0],
				[0.5190301168721783, 0.5190301168721783, 0.09567085809127247], [0.5, 1.0, 0.0],
				[0.4809698831278217, 0.5190301168721783, 0.09567085809127247], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.4892350839330522, 0.4892350839330522, 0.0725711693136156], [0.5, 0.0, 0.0],
				[0.5107649160669478, 0.4892350839330522, 0.0725711693136156], [1.0, 0.5, 0.0],
				[0.5107649160669478, 0.5107649160669478, 0.0725711693136156], [0.5, 1.0, 0.0],
				[0.4892350839330522, 0.5107649160669478, 0.0725711693136156], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.4951963201008076, 0.4951963201008076, 0.04877258050403215], [0.5, 0.0, 0.0],
				[0.5048036798991924, 0.4951963201008076, 0.04877258050403215], [1.0, 0.5, 0.0],
				[0.5048036798991924, 0.5048036798991924, 0.04877258050403215], [0.5, 1.0, 0.0],
				[0.4951963201008076, 0.5048036798991924, 0.04877258050403215], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.4987961816680492, 0.4987961816680492, 0.024504285082390206], [0.5, 0.0, 0.0],
				[0.5012038183319508, 0.4987961816680492, 0.024504285082390206], [1.0, 0.5, 0.0],
				[0.5012038183319508, 0.5012038183319508, 0.024504285082390206], [0.5, 1.0, 0.0],
				[0.4987961816680492, 0.5012038183319508, 0.024504285082390206], [0.0, 0.5, 0.0]
			]
		},
		{
			"frame_classes": ["foldedState"],
			"frame_parent":0,
			"frame_inherit":true,
			"vertices_coords": [
				[0.5, 0.5, 0.0], [0.5, 0.0, 0.0],
				[0.5, 0.5, 0.0], [1.0, 0.5, 0.0],
				[0.5, 0.5, 0.0], [0.5, 1.0, 0.0],
				[0.5, 0.5, 0.0], [0.0, 0.5, 0.0]
			]
		}
	]
};

let fishBase = {
	"file_spec": 1.1,
	"frame_title": "fish base",
	"file_classes": ["singleModel"],
	"frame_classes": ["creasePattern"],
	"frame_attributes": ["2D"],
	"vertices_coords": [[0,0],[1,0],[1,1],[0,1],[0.292893218813452,0.292893218813452],[0.707106781186548,0.707106781186548],[0.292893218813452,0],[1,0.707106781186548]],
	"faces_vertices": [[2,3,5],[3,0,4],[3,1,5],[1,3,4],[4,0,6],[1,4,6],[5,1,7],[2,5,7]],
	"edges_vertices": [[2,3],[3,0],[3,1],[0,4],[1,4],[3,4],[1,5],[2,5],[3,5],[4,6],[0,6],[6,1],[5,7],[1,7],[7,2]],
	"faces_layer": [2,3,5,6,4,7,0,1],
	"edges_assignment": ["B","B","V","M","M","M","M","M","M","V","B","B","V","B","B"],
	"file_frames": [{
		"frame_classes": ["foldedState"],
		"frame_parent":0,
		"frame_inherit":true,
		"vertices_coords": [[0.707106781186548,0.292893218813452],[1,0],[0.707106781186548,0.292893218813452],[0,1],[0.292893218813452,0.292893218813452],[0.707106781186548,0.707106781186548],[0.5,0.5],[0.5,0.5]]
	}]
};

cmMarks = [];

var slider = new Slider('#frame-slider').on("slide",sliderUpdate);
function sliderUpdate(value){
	// value.preventDefault();
	if(loadedFold.file_frames == undefined){ return; }
	let fraction = parseFloat(value / 1000);
	let frame = parseInt(fraction * loadedFold.file_frames.length);
	document.getElementById("frame-number-input").value = frame;
	// origami.setFrame(frame);
	let newFold = RabbitEar.Folder.flattenFrame(loadedFold, frame);
	updateThreeJS(newFold);
	let linenum = 156 + 49*(frame-1);
	editor.scrollIntoView({line:linenum+20});
	cmMarks.forEach(mark => mark.clear());
	cmMarks = [];
	cmMarks.push(editor.markText({line: linenum, ch: 0}, {line: linenum+49, ch: 0}, {className: "styled-background"}));
}

var loadedFold;
let cm = document.getElementsByClassName("CodeMirror")[0];
let threeCanvas = document.getElementById("three-canvas");
var scene = new THREE.Scene();

// console.log("cm.clientWidth");
// console.log(cm.clientWidth);
// console.log(threeCanvas.clientHeight);

// var camera = new THREE.PerspectiveCamera(45, threeCanvas.clientWidth/threeCanvas.clientHeight, 0.1, 1000);
var camera = new THREE.PerspectiveCamera(45, (window.innerWidth - cm.clientWidth)/threeCanvas.clientHeight, 0.1, 1000);
var controls = new THREE.OrbitControls(camera, document.getElementById("three-canvas"));
camera.position.set( 0.5, 0.5, 1.5 );
controls.target.set(0.5, 0.5, 0.0);
// camera.position.set(0.0, 0.0, 1.5 );
// controls.target.set(0.0, 0.0, 0.0);

controls.addEventListener( 'change', render );

var renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setClearColor("#FFFFFF");
// renderer.setSize( threeCanvas.clientWidth, threeCanvas.clientHeight);
renderer.setSize( (window.innerWidth - cm.clientWidth), threeCanvas.clientHeight);

threeCanvas.appendChild(renderer.domElement);

// var light0 = new THREE.PointLight(0xffffff);
// var light1 = new THREE.PointLight(0xffffff);
// var light2 = new THREE.PointLight(0xffffff);
// light0.position.set(-1,2,1);
// light1.position.set(2,-2,1);
// light2.position.set(0,0,-2);
// var ambientLight = new THREE.AmbientLight(0x444444);
// scene.add(ambientLight);

// light0.castShadow = true;
// light1.castShadow = true;
// light2.castShadow = true;
// scene.add(light0);
// scene.add(light1);
// scene.add(light2);


// var directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.7);
// directionalLight1.position.set(-100, -100, 100);
// scene.add(directionalLight1);

// shining from below
var directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.2);
directionalLight2.position.set(20, 20, -100);
scene.add(directionalLight2);

var spotLight1 = new THREE.SpotLight(0xffffff, 0.3);
spotLight1.position.set(50, -200, 100);
scene.add(spotLight1)

var spotLight2 = new THREE.SpotLight(0xffffff, 0.3);
spotLight2.position.set(100, 50, 200);
scene.add(spotLight2)

var ambientLight = new THREE.AmbientLight(0xffffff, 0.48);
scene.add(ambientLight);



var render = function(){
	requestAnimationFrame(render);
	renderer.render(scene, camera);
	controls.update();
};
render();

let allMeshes = [];

renderer.shadowMapEnabled = true;
renderer.shadowMapType = THREE.PCFSoftShadowMap;

// renderer.domElement.onmousemove = function(e){
// 	let vecs = loadedFold.vertices_coords.map(v => new THREE.Vector3(v[0], v[1], (v[2]!=undefined)?v[2]:0))
// 	let proj = vecs.map(v => v.applyMatrix4(scene.matrixWorld).project(camera))
// 	var width = threeCanvas.clientWidth / 2, height = threeCanvas.clientHeight / 2;
// 	var widthHalf = width / 2, heightHalf = height / 2;
// 	let pos = vecs.map(v => {
// 		let vec = v.clone().project(camera);
// 		vec.x = (vec.x*widthHalf) + widthHalf;
// 		vec.y = -(vec.y*heightHalf) + heightHalf;
// 		return vec;
// 	})
// 	console.log(pos);
// 	console.log(e.clientX, e.clientY)
// }

function updateThreeJS(foldFile){

	// var material = new THREE.MeshLambertMaterial({color: 0xffffff, side: THREE.DoubleSide, shadowSide:THREE.DoubleSide});
	var material = new THREE.MeshPhongMaterial({
		color: 0xffffff,
		side: THREE.DoubleSide,
		flatShading:true,
		shininess:0,
		specular:0xffffff,
		reflectivity:0
	});

	// while(scene.children.length){ scene.remove(scene.children[0]); }
	let faces = foldFileToThreeJSFaces(foldFile, material);
	let lines = foldFileToThreeJSLines(foldFile);

	allMeshes.forEach(mesh => scene.remove(mesh));
	allMeshes = [];
	allMeshes.push(faces);
	allMeshes.push(lines);
	// allMeshes = allMeshes.concat(lines);
	allMeshes.forEach(mesh => scene.add(mesh));

	// allMeshes.forEach(mesh => {mesh.castShadow = true; mesh.receiveShadow = true;});
}

function fileDidLoad(blob, mimeType, fileExtension){
	if(fileExtension == "fold"){
		loadFoldFile(JSON.parse(blob));
	}
}

function loadFoldFile(foldFile){
	loadedFold = foldFile;
	clearCodeMirror();
	injectCode(JSON.stringify(foldFile,null,'  '));
	updateThreeJS(foldFile);
}
loadFoldFile(animatedBlintzFold);

function clearCodeMirror(){
	var cm = document.getElementsByClassName("CodeMirror")[0].CodeMirror;
	cm.setValue("");
}

function injectCode(string){
	var cm = document.getElementsByClassName("CodeMirror")[0].CodeMirror;
	var doc = cm.getDoc();
	var cursor = doc.getCursor();
	var line = doc.getLine(cursor.line);
	var newline = '\n';
	if(cursor.ch == 0){ newline = ''; }
	var pos = { // create a new object to avoid mutation of the original selection
		line: (doc.size+5),
		ch: line.length - 1 // set the character position to the end of the line
	}
	doc.replaceRange(newline+string, pos);
}


function foldFileToThreeJSFaces(foldFile, material){
	
	var geometry = new THREE.BufferGeometry();
	let vertices = foldFile.vertices_coords
		.map(v => [v[0], v[1], (v[2] != undefined ? v[2] : 0)])
		.reduce((prev,curr) => prev.concat(curr), []);
	let normals = foldFile.vertices_coords
		.map(v => [0,0,1])
		.reduce((prev,curr) => prev.concat(curr), []);
	let colors = foldFile.vertices_coords
		.map(v => [1,1,1])
		.reduce((prev,curr) => prev.concat(curr), []);
	let faces = foldFile.faces_vertices
		.map(fv => fv.map((v,i,arr) => [arr[0], arr[i+1], arr[i+2]])
		             .slice(0, fv.length-2))
		.reduce((prev,curr) => prev.concat(curr), [])
		.reduce((prev,curr) => prev.concat(curr), []);

	geometry.addAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
	geometry.addAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));
	geometry.addAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
	geometry.setIndex(faces);

	// geometry.computeVertexNormals();

	if(material == undefined){ material = new THREE.MeshNormalMaterial({side: THREE.DoubleSide}); }
	return new THREE.Mesh(geometry, material);
}

function crossVec3(a,b){
	return [
		a[1]*b[2] - a[2]*b[1],
		a[2]*b[0] - a[0]*b[2],
		a[0]*b[1] - a[1]*b[0]
	];
}
function magVec3(v){
	return Math.sqrt(Math.pow(v[0],2) + Math.pow(v[1],2) + Math.pow(v[2],2));
}
function normalizeVec3(v){
	let mag = Math.sqrt(Math.pow(v[0],2) + Math.pow(v[1],2) + Math.pow(v[2],2));
	return [v[0] / mag, v[1] / mag, v[2] / mag];
}
function scaleVec3(v, scale){
	return [v[0]*scale, v[1]*scale, v[2]*scale];
}
function dotVec3(a,b){
	return a[0]*b[0] + a[1]*b[1] + a[2]*b[2];
}

function cylinderEdgeVertices(edge, radius){
	// normalized edge vector
	let vec = [edge[1][0] - edge[0][0], edge[1][1] - edge[0][1], edge[1][2] - edge[0][2]];
	let mag = Math.sqrt(Math.pow(vec[0],2) + Math.pow(vec[1],2) + Math.pow(vec[2],2));
	if(mag < 1e-10){ throw "degenerate edge"; }
	let normalized = [vec[0] / mag, vec[1] / mag, vec[2] / mag];
	let perp = [
		normalizeVec3(crossVec3(normalized, [1,0,0])),
		normalizeVec3(crossVec3(normalized, [0,1,0])),
		normalizeVec3(crossVec3(normalized, [0,0,1]))
	].map((v,i) => ({i:i, v:v, mag:magVec3(v)}))
	 .filter(v => v.mag > 1e-10)
	 .map(obj => obj.v)
	 .shift()
	let rotated = [perp];
	for(var i = 1; i < 4; i++){
		rotated.push(normalizeVec3(crossVec3(rotated[i-1], normalized)));
	}
	let dirs = rotated.map(v => scaleVec3(v, radius));
	return edge
		.map(v => dirs.map(dir => [v[0]+dir[0], v[1]+dir[1], v[2]+dir[2]]))
		.reduce((prev,curr) => prev.concat(curr), []);
}

function foldFileToThreeJSLines(foldFile, scale=0.0015){
	let edges = foldFile.edges_vertices.map(ev => ev.map(v => foldFile.vertices_coords[v]));
	// make sure they all have a z component. when z is implied it's 0
	edges.forEach(edge => {
		if(edge[0][2] == undefined){ edge[0][2] = 0; }
		if(edge[1][2] == undefined){ edge[1][2] = 0; }
	})

	// let colorAssignments = {
	// 	"B": 0x2299CC,
	// 	"F": 0x666666,
	// 	"M": 0x2299CC,
	// 	"V": 0xDD5522 };
	let colorAssignments = {
		"B": [0.0,0.0,0.0],
		"M": [0.5,0.0333,0.0666],
		"F": [0.25,0.25,0.25],
		"V": [0.05,0.1,0.45]
		// "V": [0.3,0.6,1.0]
	};

	// let colors = foldFile.vertices_coords
	// 	.map(v => [1,1,1])
	// 	.reduce((prev,curr) => prev.concat(curr), []);

	let colors = foldFile.edges_assignment.map(e => 
		[colorAssignments[e], colorAssignments[e], colorAssignments[e], colorAssignments[e],
		colorAssignments[e], colorAssignments[e], colorAssignments[e], colorAssignments[e]]
	).reduce((prev,curr) => prev.concat(curr), [])
	 .reduce((prev,curr) => prev.concat(curr), [])
	 .reduce((prev,curr) => prev.concat(curr), []);

	let vertices = edges
		.map(edge => cylinderEdgeVertices(edge, scale))
		.reduce((prev,curr) => prev.concat(curr), [])
		.reduce((prev,curr) => prev.concat(curr), []);

	let normals = edges.map(edge => {
		// normalized edge vector
		let vec = [edge[1][0] - edge[0][0], edge[1][1] - edge[0][1], edge[1][2] - edge[0][2]];
		let mag = Math.sqrt(Math.pow(vec[0],2) + Math.pow(vec[1],2) + Math.pow(vec[2],2));
		if(mag < 1e-10){ throw "degenerate edge"; }
		let normalized = [vec[0] / mag, vec[1] / mag, vec[2] / mag];
		// scale to line width
		let scaled = [normalized[0]*scale, normalized[1]*scale, normalized[2]*scale];
		let c0 = scaleVec3(normalizeVec3(crossVec3(vec, [0,0,-1])), scale);
		let c1 = scaleVec3(normalizeVec3(crossVec3(vec, [0,0,1])), scale);
		return [
			c0, [-c0[2], c0[1], c0[0]],
			c1, [-c1[2], c1[1], c1[0]],
			c0, [-c0[2], c0[1], c0[0]],
			c1, [-c1[2], c1[1], c1[0]]
		]
	}).reduce((prev,curr) => prev.concat(curr), [])
	  .reduce((prev,curr) => prev.concat(curr), []);

	let faces = edges.map((e,i) => [
		// 8 triangles making the long cylinder
		i*8+0, i*8+4, i*8+1,
		i*8+1, i*8+4, i*8+5,
		i*8+1, i*8+5, i*8+2,
		i*8+2, i*8+5, i*8+6,
		i*8+2, i*8+6, i*8+3,
		i*8+3, i*8+6, i*8+7,
		i*8+3, i*8+7, i*8+0,
		i*8+0, i*8+7, i*8+4,
		// endcaps
		i*8+0, i*8+1, i*8+3,
		i*8+1, i*8+2, i*8+3,
		i*8+5, i*8+4, i*8+7,
		i*8+7, i*8+6, i*8+5,
	]).reduce((prev,curr) => prev.concat(curr), []);

	var geometry = new THREE.BufferGeometry();
	geometry.addAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
	geometry.addAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));
	geometry.addAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
	geometry.setIndex(faces);
	geometry.computeVertexNormals();

	// let material = new THREE.MeshNormalMaterial({side: THREE.DoubleSide});
	// let boundaryMaterial = new THREE.MeshPhongMaterial({
	// 	color: 0x000000, specular:0x000000,
	// 	side: THREE.DoubleSide, flatShading:true, shininess:0, reflectivity:0});
	// let markMaterial = new THREE.MeshPhongMaterial({
	// 	color: 0x666666, specular:0x666666, diffuse:0xffffff,
	// 	side: THREE.DoubleSide, flatShading:true, shininess:0, reflectivity:0});
	// let mountainMaterial = new THREE.MeshPhongMaterial({
	// 	color: 0x2299CC, specular:0x2299CC, diffuse:0xffffff,
	// 	side: THREE.DoubleSide, flatShading:true, shininess:0, reflectivity:0});
	// let valleyMaterial = new THREE.MeshPhongMaterial({
	// 	color: 0xDD5522, specular:0xDD5522, diffuse:0xffffff,
	// 	side: THREE.DoubleSide, flatShading:true, shininess:0, reflectivity:0});
	// let materialMap = {
	// 	"B": boundaryMaterial,
	// 	"F": markMaterial,
	// 	"M": mountainMaterial,
	// 	"V": valleyMaterial,
	// };

	var material = new THREE.MeshToonMaterial( {
			// color: 0xffffff, 
			shininess: 0,
			side: THREE.DoubleSide, vertexColors: THREE.VertexColors
	} );

	// let material = materialMap[foldFile.edges_assignment[]]
	// let whiteMaterial = new THREE.MeshPhongMaterial({
		// color: 0x666666, specular:0x666666, side: THREE.DoubleSide, flatShading:true, shininess:0.5, reflectivity:0.5});
	return new THREE.Mesh(geometry, material);
}
